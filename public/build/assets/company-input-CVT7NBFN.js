document.addEventListener("DOMContentLoaded",function(){const c=document.getElementById("company-input"),t=document.getElementById("input-results"),s=document.getElementById("corporate_number"),d=document.getElementById("company_name"),p=document.getElementById("input-button");let l,i={};c.addEventListener("input",function(){clearTimeout(l),l=setTimeout(()=>{const e=this.value.trim();e.length>1?u(e):(t.innerHTML="",t.classList.add("hidden"))},500)}),p.addEventListener("click",function(e){e.preventDefault();const r=c.value.trim();r.length>1&&u(r)});function u(e){if(i[e]){m(i[e]);return}const r=`/api/company-search?query=${encodeURIComponent(e)}`;f(),fetch(r).then(n=>{if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return n.json()}).then(n=>{if(console.log("Raw API Response:",n),n.errors)throw new Error(n.errors);let o=[];n["hojin-infos"]&&Array.isArray(n["hojin-infos"])&&(o=n["hojin-infos"].map(a=>({company_name:a.name,location:a.location,corporate_number:a.corporate_number}))),console.log("Processed companies:",o),i[e]=o,m(o)}).catch(n=>{console.error("Error:",n),t.innerHTML='<p class="p-2 text-red-500">検索中にエラーが発生しました。: '+n.message+"</p>",t.classList.remove("hidden")}).finally(()=>{v()})}function m(e){if(t.innerHTML="",e.length===0)t.innerHTML='<p class="p-2">検索結果がありません。</p>';else{const r=document.createElement("p");r.className="p-2 text-sm text-gray-600",r.textContent=`${e.length}件の結果`,t.appendChild(r);const n=document.createElement("ul");n.className="divide-y divide-gray-200",e.forEach(o=>{const a=document.createElement("li");a.className="p-1 hover:bg-gray-100 cursor-pointer transition duration-150 ease-in-out",a.innerHTML=`
                    <div class="text-sm font-medium text-gray-800">${o.company_name}</div>
                    <div class="text-xs text-gray-500">${o.location||"所在地不明"}</div>
                `,a.addEventListener("click",()=>{c.value=o.company_name,s.value=o.corporate_number,d.value=o.company_name,t.classList.add("hidden")}),n.appendChild(a)}),t.appendChild(n)}t.classList.remove("hidden"),console.log("Displayed results:",e)}function f(){const e=document.createElement("div");e.id="search-loader",e.className="text-center p-3",e.innerHTML='<div class="inline-block animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-cyan-500"></div>',t.innerHTML="",t.appendChild(e),t.classList.remove("hidden")}function v(){const e=document.getElementById("search-loader");e&&e.remove()}document.addEventListener("click",function(e){!t.contains(e.target)&&e.target!==c&&t.classList.add("hidden")});const h=new URLSearchParams(window.location.search).get("corporate_number");h&&fetch(`/api/companies/${h}`).then(e=>e.json()).then(e=>{c.value=e.company_name,d.value=e.company_name,s.value=e.corporate_number}).catch(e=>console.error("Error:",e))});
